<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ•ã‚©ãƒ«ãƒ€å†…ã®æ–‡å­—åˆ—ä¸€æ‹¬ç½®æ›ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä»˜ãï¼‰</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    label { display: block; margin-top: 1em; }
    #output {
      white-space: pre-wrap;
      background: #f9f9f9;
      border: 1px solid #ccc;
      padding: 1em;
      margin-top: 1em;
      max-height: 400px;
      overflow-y: auto;
    }
    button { margin-top: 1em; }
  </style>
</head>
<body>
  <h2>ãƒ•ã‚©ãƒ«ãƒ€å†…ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€æ‹¬ç½®æ›ï¼ˆZIPãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä»˜ãï¼‰</h2>
  
  <label>
    æ¤œç´¢æ–‡å­—åˆ—:
    <input type="text" id="searchText" placeholder="ç½®æ›ã—ãŸã„æ–‡å­—åˆ—">
  </label>
  <label>
    ç½®æ›å¾Œã®æ–‡å­—åˆ—:
    <input type="text" id="replaceText" placeholder="ç½®æ›å¾Œã®æ–‡å­—åˆ—">
  </label>
  <label>
    <input type="checkbox" id="backupZip" checked="checked"> ç½®æ›å‰ã«ZIPåŒ–ã—ã¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å…ˆã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚æã‚‰ããƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ã§ã™ï¼‰
  </label>
  
  <button id="selectFolderBtn">ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ç½®æ›å®Ÿè¡Œ</button>
  <div id="output"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    document.getElementById('selectFolderBtn').addEventListener('click', async () => {
      const searchText = document.getElementById('searchText').value;
      const replaceText = document.getElementById('replaceText').value;
      const backupZip = document.getElementById('backupZip').checked;
      const output = document.getElementById('output');
      output.textContent = '';

      if (!searchText) {
        alert("æ¤œç´¢æ–‡å­—åˆ—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      try {
        const dirHandle = await window.showDirectoryPicker();
        let modifiedFiles = 0;

        if (backupZip) {
          output.textContent += "ğŸ”„ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆä¸­...\n";
          const zip = new JSZip();

          async function addToZip(handle, path = "") {
            for await (const entry of handle.values()) {
              const entryPath = path + entry.name;
              if (entry.kind === 'file') {
                const file = await entry.getFile();
                const content = await file.arrayBuffer();
                zip.file(entryPath, content);
              } else if (entry.kind === 'directory') {
                await addToZip(entry, entryPath + "/");
              }
            }
          }

          await addToZip(dirHandle);

          const blob = await zip.generateAsync({ type: "blob" });
          const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
          const backupFileName = `backup-${timestamp}.zip`;
          
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = backupFileName;
          link.click();
          URL.revokeObjectURL(link.href);

          output.textContent += `âœ” ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— ${backupFileName} ã‚’ä½œæˆã—ã¾ã—ãŸã€‚\n\n`;
        }

        output.textContent += "ğŸ” ç½®æ›å‡¦ç†ã‚’é–‹å§‹...\n";

        async function replaceInFiles(handle) {
          for await (const entry of handle.values()) {
            if (entry.kind === 'file') {
              const fileHandle = entry;
              const file = await fileHandle.getFile();
              const text = await file.text();

              if (text.includes(searchText)) {
                const updatedText = text.split(searchText).join(replaceText);
                const writable = await fileHandle.createWritable();
                await writable.write(updatedText);
                await writable.close();
                modifiedFiles++;
                output.textContent += `âœ” ${entry.name} ã‚’ç½®æ›ã—ã¾ã—ãŸ\n`;
              }
            } else if (entry.kind === 'directory') {
              await replaceInFiles(entry);
            }
          }
        }

        await replaceInFiles(dirHandle);

        if (modifiedFiles > 0) {
          output.textContent += `\nâœ… ${modifiedFiles} ä»¶ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®æ›ã—ã¾ã—ãŸã€‚`;
        } else {
          output.textContent += `\nâš  ç½®æ›å¯¾è±¡ã®æ–‡å­—åˆ—ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`;
        }

      } catch (err) {
        console.error(err);
        output.textContent = `âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}`;
      }
    });
  </script>
</body>
</html>
